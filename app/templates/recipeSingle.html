{% from '_macros.html' import allergy_badge as allergy_badge %}
{% from '_macros.html' import recipeSingle_usedIngredientsTr as usedIngredientsTr %}
{% include "header.html" %}

<main>
    <div class="jumbotron jumbotron-fluid">
        <div class="container">
            {% if recipe %}
                <h1>Edit Recipe <i class="fas fa-file-alt"></i></h1>
                <div class="my-3">
                    <p>ID: <span class="badge badge-info">{{ recipe.recipe_uid }}</span></p>
                    <p>Creator: <span class="badge badge-info">{{ recipe.user_username }}</span></p>
                </div>
            {% else %}
                <h1>New Recipe <i class="fas fa-file-alt"></i></h1>
                <p>Creator: <span class="badge badge-info">{{ mm_current_user.user_username }}</span></p>
            {% endif %}

            <div class="my-3">
                <form method="post">
                    {% if recipe %}
                        <input type="hidden" name="recipe_id" value="{{ recipe.recipe_uid }}">
                    {% endif %}

                    <h4>{% if recipe %}Edit{% else %}Set{% endif %} Properties</h4>
                    <label for="input_recipe_name" class="sr-only">Name</label>
                    <input
                            type="name"
                            name="recipe_name"
                            id="input_recipe_name"
                            class="form-control mb-2"
                            placeholder="Name"
                            autocomplete="off"
                            value="{% if recipe %}{{ recipe.recipe_name }}{% endif %}"
                            autofocus
                            required>

                    {#                    <hr class="my-3">#}

                    <div class="card-deck mb-3">
                        <div class="card">
                            <h5 class="card-header">List of Used Ingredients</h5>
                            <div class="card-body p-0">
                                <table id="recipeSingle_usedIngredientsTable"
                                       class="table table-hover m-0 recipe_ingredient_list">
                                    <tbody>
                                    {% for used_ing in used_ingredients %}
                                        {% set i = loop.index0 %}
                                        {% set ing_id = used_ing.ingredient_uid %}
                                        {% set ing_name = used_ing.ingredient_name %}
                                        {% set amount = used_ing.ir_weight %}
                                        {% set ir_id = used_ing.ir_uid %}
                                        {% set disabled_first = 'disabled' if i == 0 else '' %}
                                        {% set disabled_last = 'disabled' if i == loop.length - 1 else '' %}
                                        {{ usedIngredientsTr(i, i|int + 1, ing_id, ing_name,
                                                             amount, ir_id, disabled_first, disabled_last) }}
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <h5 class="card-header">List of All Ingredients</h5>
                            <div class="card-body p-0">
                                <table class="table table-hover m-0 recipe_ingredient_list">
                                    <tbody>
                                    {% for all_ing in all_ingredients %}
                                        <tr>
                                            <th
                                                    scope="row"
                                                    class="align-middle"
                                                    style="padding-left: 20px;"
                                                    width="99%">
                                                {{ all_ing['ingredient_name'] }}
                                            </th>
                                            <td class="align-middle" style="white-space: nowrap;">
                                                {{ allergy_badge(all_ing['ingredient_glutenfree'], '', 'G') }}
                                                {{ allergy_badge(all_ing['ingredient_lactosefree'], '', 'L') }}
                                            </td>
                                            <td class="align-middle"
                                                style="white-space: nowrap;">{{ all_ing['ingredient_price'] }} â‚¬
                                                / g
                                            </td>
                                            <td class="align-middle" style="padding-right: 20px;">
                                                {% set disabled = namespace(str='') %}
                                                {% for used_ing in used_ingredients %}
                                                    {% if used_ing.ingredient_uid == all_ing.ingredient_uid %}
                                                        {% set disabled.str = 'disabled' %}
                                                    {% endif %}
                                                {% endfor %}
                                                <button type="button" class="btn btn-success"
                                                        id="button_add_ingredient_{{ all_ing['ingredient_uid'] }}"
                                                        onclick='add_ingredient({{ all_ing|tojson }});' {{ disabled.str }}>
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <button name="cmd" value="{% if recipe %}edit{% else %}add{% endif %}"
                            class="btn btn-primary btn-lg btn-block">Save
                    </button>
                </form>
            </div>
            {% if recipe %}
                <div class="my-3">
                    <h4>Danger Zone</h4>
                    <form method="post">
                        <button name="cmd" value="delete" class="btn btn-danger btn-lg btn-block">
                            Delete {{ recipe.recipe_name }}</button>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>
</main>

{#<script src="../static/js/recipeSingle.js"></script>#}

<script type="application/javascript">
    var ingredients_dict = {};
    {% for ingredient in used_ingredients %}
        {% set i = loop.index0 %}
        {% set ing_id = ingredient.ingredient_uid %}
        {% set ing_name = ingredient.ingredient_name %}
        {% set amount = ingredient.ir_weight %}
        {% set ir_id = ingredient.ir_uid %}
        {#var txt = '{"ing_id": {{ ing_id }},' +#}
        {#           '"ing_name": "{{ ing_name }}",' +#}
        {#           '"ir_id": {{ ir_id }}}'#}
        ingredients_dict[{{ i }}] = {
            "ing_id": {{ ing_id }}, "ing_name": "{{ ing_name }}",
            "amount": {{ amount }}, "ir_id": {{ ir_id }}
        };
    {% endfor %}

    function get_tr_html(i, ing_id, ing_name, amount, ir_id, disabled_first, disabled_last) {
        {% set new_tr_html = usedIngredientsTr("' + i + '", "' + (parseInt(i) + 1) + '",
                                               "' + ing_id + '", "' + ing_name + '",
                                               "' + amount + '", "' + ir_id + '",
                                               "' + disabled_first + '", "' + disabled_last + '") %}
        return '{{ new_tr_html|replace("\n", " ")|replace("    ", " ") }}';
    }

    function update_tbl() {
        let tbl_body = document.getElementById('recipeSingle_usedIngredientsTable').getElementsByTagName('tbody')[0];
        let dict_length = Object.keys(ingredients_dict).length;
        tbl_body.innerHTML = '';
        for (const [index, ing] of Object.entries(ingredients_dict)) {
            var disabled_first = (index == 0 ? 'disabled' : '');
            var disabled_last = (index == dict_length - 1 ? 'disabled' : '');
            var new_tr_html = get_tr_html(index, ing['ing_id'], ing['ing_name'], ing['amount'],
                ing['ir_id'], disabled_first, disabled_last);
            tbl_body.innerHTML += new_tr_html;
        }
    }

    function update_dict_amounts() {
        for (const [index, ing] of Object.entries(ingredients_dict)) {
            var input_field = document.getElementById('input_amount_' + index);
            if (input_field != null) {
                ingredients_dict[index]['amount'] = input_field.value;
            }
        }
    }

    function add_ingredient(ing) {
        let i = Object.keys(ingredients_dict).length;
        ingredients_dict[i] = {
            "ing_id": ing['ingredient_uid'], "ing_name": ing['ingredient_name'],
            "amount": 0, "ir_id": ""
        };
        document.getElementById('button_add_ingredient_' + ing['ingredient_uid']).disabled = true;
        update_tbl();
    }

    function move_up_ingredient(index) {
        if (index > 0) {
            update_dict_amounts();
            let tmp_ing = ingredients_dict[index - 1];
            ingredients_dict[index - 1] = ingredients_dict[index];
            ingredients_dict[index] = tmp_ing;
            update_tbl();
        }
    }

    function move_down_ingredient(index) {
        if (index < Object.keys(ingredients_dict).length - 1) {
            update_dict_amounts();
            let tmp_ing = ingredients_dict[index + 1];
            ingredients_dict[index + 1] = ingredients_dict[index];
            ingredients_dict[index] = tmp_ing;
            update_tbl();
        }
    }

    function delete_ingredient(index, ing_id) {
        delete ingredients_dict[index];
        var new_dict = {};
        var new_index = 0;
        var no_more_kind_of_this_ing = true;
        for (const [index, ing] of Object.entries(ingredients_dict)) {
            new_dict[new_index++] = ing;
            if (ing['ing_id'] == ing_id) {
                no_more_kind_of_this_ing = false;
            }
        }
        ingredients_dict = new_dict;

        if (no_more_kind_of_this_ing) {
            document.getElementById('button_add_ingredient_' + ing_id).disabled = false;
        }

        update_tbl();
    }

</script>

{% include "footer.html" %}